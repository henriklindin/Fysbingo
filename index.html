    // Use separate arrays for unique IDs and user-facing names
    let exercises = ['skott', 'upphopp', 'trakula', 'lopning', 'situps'];
    let columnNames = ['100 skott', '40 upphopp', '10 min trÃ¤kula', '2,5 km lÃ¶pning', '50 situps'];
    const months = ['januari', 'februari', 'mars', 'april', 'maj', 'juni', 'juli', 'augusti', 'september', 'oktober', 'november', 'december'];
    const weekdays = ['sÃ¶ndag', 'mÃ¥ndag', 'tisdag', 'onsdag', 'torsdag', 'fredag', 'lÃ¶rdag'];

    let workoutData = {};
    let userName = '';
    let badges = {}; // Store badges { columnId: 'bronze' | 'silver' | 'gold' }
    let goldRows = [];

    // Create and register manifest dynamically
    function createManifest() {
        const manifest = {
            "name": "Fysbingo",
            "short_name": "Fysbingo",
            "start_url": "./",
            "display": "standalone",
            "orientation": "portrait",
            "theme_color": "#2d3a87",
            "background_color": "#f3f4f6",
            "icons": [{
                "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjMkQzQTg3Ii8+CjxwYXRoIGQ9Ik00OCA5NkM0OCA3MS4wNCA2OC4wNCA1MSA5MyA1MUgxMzkuNUM0OCA5NkM0OCA3MS4wNCA2OC4wNCA1MSA5MyA1MUgxMzkuNSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSI4IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPHBhdGggZD0iTTQ4IDEyMEM0OCA5NS4wNCA2OC4wNCA3NSA5MyA3NUgxMzkuNSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSI4IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPHBhdGggZD0iTTQ4IDE0NEM0OCAxMTkuMDQgNjguMDQgOTkgOTMgOTlIMTM5LjUiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iOCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+CjwvZz4KPC9zdmc+",
                "sizes": "192x192",
                "type": "image/svg+xml"
            }]
        };

        const manifestBlob = new Blob([JSON.stringify(manifest)], {
            type: 'application/json'
        });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').href = manifestURL;
    }

    // Service Worker registration for PWA functionality (only on HTTPS or localhost)
    if ('serviceWorker' in navigator && (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1')) {
        window.addEventListener('load', () => {
            const swCode = `
                const CACHE_NAME = 'fysbingo-v1';
                const urlsToCache = [
                    './',
                    './?standalone=true'
                ];

                self.addEventListener('install', (event) => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                        .then((cache) => {
                            return cache.addAll(urlsToCache);
                        })
                    );
                    self.skipWaiting();
                });

                self.addEventListener('fetch', (event) => {
                    event.respondWith(
                        caches.match(event.request)
                        .then((response) => {
                            if (response) {
                                return response;
                            }
                            return fetch(event.request);
                        })
                    );
                });

                self.addEventListener('activate', (event) => {
                    event.waitUntil(
                        caches.keys().then((cacheNames) => {
                            return Promise.all(
                                cacheNames.map((cacheName) => {
                                    if (cacheName !== CACHE_NAME) {
                                        return caches.delete(cacheName);
                                    }
                                })
                            );
                        })
                    );
                });
            `;

            const blob = new Blob([swCode], {
                type: 'application/javascript'
            });
            const swUrl = URL.createObjectURL(blob);

            navigator.serviceWorker.register(swUrl)
                .then(registration => {
                    console.log('Service Worker registered successfully');
                })
                .catch(error => {
                    console.log('Service Worker registration failed (this is normal on file:// protocol):', error);
                });
        });
    } else {
        console.log('Service Worker not available - app will still work normally');
    }

    // Enhanced data persistence with multiple storage methods
    function loadData() {
        const savedName = localStorage.getItem('fysbingoName') || sessionStorage.getItem('fysbingoName') || '';
        const savedData = localStorage.getItem('fysbingoData') || sessionStorage.getItem('fysbingoData') || '{}';
        const savedExercises = localStorage.getItem('fysbingoExercises');
        const savedColumnNames = localStorage.getItem('fysbingoColumnNames');

        if (savedName) {
            userName = savedName;
            document.getElementById('nameInput').value = userName;
        }
        if (savedExercises) {
            exercises = JSON.parse(savedExercises);
        }
        if (savedColumnNames) {
            columnNames = JSON.parse(savedColumnNames);
        }

        try {
            workoutData = JSON.parse(savedData);
        } catch (e) {
            workoutData = {};
        }
    }

    // Save data to persistent storage
    function saveData() {
        try {
            localStorage.setItem('fysbingoName', userName);
            localStorage.setItem('fysbingoData', JSON.stringify(workoutData));
            localStorage.setItem('fysbingoExercises', JSON.stringify(exercises));
            localStorage.setItem('fysbingoColumnNames', JSON.stringify(columnNames));
            sessionStorage.setItem('fysbingoName', userName);
            sessionStorage.setItem('fysbingoData', JSON.stringify(workoutData));
        } catch (e) {
            console.log('Storage unavailable, using memory only');
        }
    }

    function startApp() {
        const nameInput = document.getElementById('nameInput').value.trim();
        if (!nameInput) {
            alert('VÃ¤nligen skriv ditt namn!');
            return;
        }

        userName = nameInput;
        saveData();

        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('trackerScreen').style.display = 'block';

        updateHeader();
        generateCalendar();
        updateBadges();
    }

    function goBack() {
        document.getElementById('trackerScreen').style.display = 'none';
        document.getElementById('welcomeScreen').style.display = 'block';
    }

    function updateHeader() {
        document.getElementById('userName').textContent = `Hej ${userName}! ðŸ‘‹`;

        const today = new Date();
        const dayName = weekdays[today.getDay()];
        const dayNumber = today.getDate();
        const monthName = months[today.getMonth()];

        document.getElementById('currentDate').textContent =
            `Idag Ã¤r ${dayName} ${dayNumber} ${monthName}`;
    }

    function generateCalendar() {
        const thead = document.getElementById('columnHeaders');
        const tbody = document.getElementById('workoutTableBody');
        thead.innerHTML = '<th>Datum</th>';
        tbody.innerHTML = '';

        // Add new headers with streak classes
        columnNames.forEach((name, index) => {
            const th = document.createElement('th');
            th.textContent = name;
            th.setAttribute('data-column-id', exercises[index]);
            const streakType = getColumnStreakType(exercises[index]);
            if (streakType) {
                th.classList.add(`${streakType}-streak`);
            }
            thead.appendChild(th);
        });

        const today = new Date();
        const currentDay = today.getDate();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        const daysInMonth = 31; // August has 31 days

        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(currentYear, 7, day);
            const dateKey = `${date.getFullYear()}-08-${day.toString().padStart(2, '0')}`;

            const row = document.createElement('tr');
            if (isGoldRow(dateKey)) {
                row.classList.add('gold-row');
            }

            if (currentMonth === 7 && currentDay === day && currentYear === date.getFullYear()) {
                row.classList.add('today-row');
            }

            const dateCell = document.createElement('td');
            dateCell.textContent = `${day}/8`;
            row.appendChild(dateCell);

            exercises.forEach(exercise => {
                const cell = document.createElement('td');
                cell.classList.add('exercise-cell');
                cell.dataset.date = dateKey;
                cell.dataset.exercise = exercise;

                const status = getExerciseStatus(dateKey, exercise);
                updateCellDisplay(cell, status);

                let tapCount = 0;
                let tapTimer = null;

                cell.addEventListener('click', (e) => {
                    e.preventDefault();
                    tapCount++;

                    if (tapCount === 1) {
                        tapTimer = setTimeout(() => {
                            if (tapCount === 1) {
                                handleSingleTap(dateKey, exercise, cell);
                            }
                            tapCount = 0;
                        }, 300);
                    } else if (tapCount === 2) {
                        clearTimeout(tapTimer);
                        handleDoubleTap(dateKey, exercise, cell);
                        tapCount = 0;
                    }
                });

                row.appendChild(cell);
            });

            tbody.appendChild(row);
        }
    }

    function getExerciseStatus(date, exercise) {
        if (!workoutData[date]) return 'none';
        return workoutData[date][exercise] || 'none';
    }

    function setExerciseStatus(date, exercise, status) {
        if (!workoutData[date]) {
            workoutData[date] = {};
        }
        workoutData[date][exercise] = status;
        saveData();
        updateBadges();
    }

    function handleSingleTap(date, exercise, cell) {
        const currentStatus = getExerciseStatus(date, exercise);
        const newStatus = currentStatus === 'done' ? 'none' : 'done';
        setExerciseStatus(date, exercise, newStatus);
        updateCellDisplay(cell, newStatus);
        updateRowStatus(date); // Update the row background immediately
    }

    function handleDoubleTap(date, exercise, cell) {
        const currentStatus = getExerciseStatus(date, exercise);
        const newStatus = currentStatus === 'skipped' ? 'none' : 'skipped';
        setExerciseStatus(date, exercise, newStatus);
        updateCellDisplay(cell, newStatus);
        updateRowStatus(date); // Update the row background immediately
    }

    function updateRowStatus(dateKey) {
        const row = document.querySelector(`tr:has(td[data-date="${dateKey}"])`);
        if (row) {
            if (isGoldRow(dateKey)) {
                row.classList.add('gold-row');
            } else {
                row.classList.remove('gold-row');
            }
        }
    }

    function updateCellDisplay(cell, status) {
        cell.classList.remove('done', 'skipped');
        cell.innerHTML = '';

        if (status === 'done') {
            cell.classList.add('done');
            cell.innerHTML = '<span class="checkmark done">âœ“</span>';
        } else if (status === 'skipped') {
            cell.classList.add('skipped');
            cell.innerHTML = '<span class="checkmark skipped">âœ—</span>';
        }
    }

    function resetData() {
        if (confirm('Ã„r du sÃ¤ker pÃ¥ att du vill Ã¥terstÃ¤lla alla trÃ¤ningsdata? Detta kan inte Ã¥ngras.')) {
            workoutData = {};
            badges = {};
            saveData();
            generateCalendar();
            updateBadgeDisplay();

            const originalText = document.querySelector('.reset-btn').textContent;
            document.querySelector('.reset-btn').textContent = 'âœ… Ã…terstÃ¤llt!';
            setTimeout(() => {
                document.querySelector('.reset-btn').textContent = originalText;
            }, 2000);
        }
    }

    // --- New Functionality: Column Editing ---
    document.getElementById('editIcon').addEventListener('click', () => {
        const editor = document.getElementById('columnEditor');
        editor.style.display = editor.style.display === 'block' ? 'none' : 'block';
        populateColumnEditor();
    });

    document.getElementById('addColumnBtn').addEventListener('click', () => {
        const newName = document.getElementById('newColumnName').value.trim();
        if (newName && !columnNames.includes(newName)) {
            const newExerciseId = `ex-${Date.now()}`;
            exercises.push(newExerciseId);
            columnNames.push(newName);
            document.getElementById('newColumnName').value = '';
            saveData();
            generateCalendar();
            updateBadges();
            populateColumnEditor();
        }
    });

    function populateColumnEditor() {
        const list = document.getElementById('columnEditorList');
        list.innerHTML = '';

        columnNames.forEach((name, index) => {
            const item = document.createElement('div');
            item.classList.add('column-editor-item');
            const input = document.createElement('input');
            input.type = 'text';
            input.value = name;
            const saveBtn = document.createElement('button');
            saveBtn.classList.add('save-btn');
            saveBtn.textContent = 'Spara';
            saveBtn.onclick = () => {
                columnNames[index] = input.value.trim();
                saveData();
                generateCalendar();
                updateBadges();
                populateColumnEditor();
            };
            const removeBtn = document.createElement('button');
            removeBtn.classList.add('remove-btn');
            removeBtn.textContent = 'Ta bort';
            removeBtn.onclick = () => {
                if (confirm(`Ã„r du sÃ¤ker pÃ¥ att du vill ta bort kolumnen "${name}"? Detta kommer ocksÃ¥ ta bort all data fÃ¶r den.`)) {
                    const columnId = exercises[index];
                    exercises.splice(index, 1);
                    columnNames.splice(index, 1);
                    Object.keys(workoutData).forEach(date => {
                        delete workoutData[date][columnId];
                    });
                    saveData();
                    generateCalendar();
                    updateBadges();
                    populateColumnEditor();
                }
            };

            item.appendChild(input);
            item.appendChild(saveBtn);
            item.appendChild(removeBtn);
            list.appendChild(item);
        });
    }

    // --- New Functionality: Streaks & Badges ---
    function updateBadges() {
        badges = {};
        const daysInMonth = 31; 
        goldRows = [];

        // Calculate column streaks for Bronze and Silver
        exercises.forEach(exercise => {
            let streak = 0;
            let longestStreak = 0;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `2025-08-${day.toString().padStart(2, '0')}`;
                const status = getExerciseStatus(dateKey, exercise);
                
                if (status === 'done') {
                    streak++;
                } else {
                    longestStreak = Math.max(longestStreak, streak);
                    streak = 0;
                }
            }
            longestStreak = Math.max(longestStreak, streak);

            if (longestStreak >= 4) {
                badges[exercise] = 'silver';
            } else if (longestStreak >= 2) {
                badges[exercise] = 'bronze';
            }
        });

        // Check for gold badges (full rows)
        for (let day = 1; day <= daysInMonth; day++) {
            const dateKey = `2025-08-${day.toString().padStart(2, '0')}`;
            if (isGoldRow(dateKey)) {
                goldRows.push(dateKey);
            }
        }
        
        saveData();
        generateCalendar();
        updateBadgeDisplay();
    }

    function getColumnStreakType(exerciseId) {
        return badges[exerciseId] || '';
    }
    
    function isGoldRow(dateKey) {
        const dayData = workoutData[dateKey];
        if (!dayData) return false;
        
        // Ensure all exercises for that day are marked as 'done'
        return exercises.every(exercise => dayData[exercise] === 'done');
    }

    function updateBadgeDisplay() {
        const counts = {
            bronze: 0,
            silver: 0,
            gold: goldRows.length
        };
        
        Object.values(badges).forEach(badge => {
            if (badge === 'bronze') counts.bronze++;
            if (badge === 'silver') counts.silver++;
        });

        document.getElementById('bronzeCount').textContent = counts.bronze;
        document.getElementById('silverCount').textContent = counts.silver;
        document.getElementById('goldCount').textContent = counts.gold;
    }


    // --- New Functionality: Export & Print Table ---
    function exportMonthTable() {
        const printWindow = window.open('', '', 'height=800,width=800');
        printWindow.document.write('<html><head><title>Fysbingo MÃ¥nadsrapport</title>');
        printWindow.document.write('<style>');
        printWindow.document.write('table{width:100%;border-collapse:collapse;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;margin-top:20px;}');
        printWindow.document.write('th,td{border:1px solid #ddd;padding:8px;text-align:center;}');
        printWindow.document.write('th{background-color:#667eea;color:white;}');
        printWindow.document.write('td.done{background-color:#d4edda;}');
        printWindow.document.write('td.skipped{background-color:#f8d7da;}');
        printWindow.document.write('td.day-cell{text-align:left;font-weight:bold;}');
        printWindow.document.write('h1{text-align:center;color:#2d3a87;}');
        printWindow.document.write('p{text-align:center;color:#666;font-size:16px;}');
        printWindow.document.write('.badges{display:flex;justify-content:center;gap:20px;margin-bottom:20px;}');
        printWindow.document.write('.badge-item{font-size:24px;}');
        printWindow.document.write('.badge-item span{font-size:16px;margin-left:5px;}');
        printWindow.document.write('tr.gold-row{background-color:#ffd700;}');
        printWindow.document.write('tr.gold-row td {background-color:#ffd700;}');
        printWindow.document.write('</style>');
        printWindow.document.write('</head><body>');
        printWindow.document.write(`<h1>Fysbingo MÃ¥nadsrapport fÃ¶r ${months[7]}</h1>`);
        printWindow.document.write(`<p>Namn: ${userName}</p>`);
        
        const counts = { bronze: 0, silver: 0, gold: goldRows.length };
        Object.values(badges).forEach(badge => {
            if (badge === 'bronze') counts.bronze++;
            if (badge === 'silver') counts.silver++;
        });
        printWindow.document.write('<div class="badges">');
        printWindow.document.write(`<div class="badge-item">ðŸ¥‰<span>${counts.bronze}</span></div>`);
        printWindow.document.write(`<div class="badge-item">ðŸ¥ˆ<span>${counts.silver}</span></div>`);
        printWindow.document.write(`<div class="badge-item">ðŸ¥‡<span>${counts.gold}</span></div>`);
        printWindow.document.write('</div>');

        let tableHtml = '<table><thead><tr><th>Datum</th>';
        columnNames.forEach(name => {
            tableHtml += `<th>${name}</th>`;
        });
        tableHtml += '</tr></thead><tbody>';

        const currentYear = new Date().getFullYear();
        const daysInMonth = 31;
        for (let day = 1; day <= daysInMonth; day++) {
            const dateKey = `${currentYear}-08-${day.toString().padStart(2, '0')}`;
            const isGold = isGoldRow(dateKey);
            tableHtml += `<tr class="${isGold ? 'gold-row' : ''}">`;
            tableHtml += `<td class="day-cell">${day}/8</td>`;
            exercises.forEach(exercise => {
                const status = getExerciseStatus(dateKey, exercise);
                let symbol = '';
                let className = '';
                if (status === 'done') {
                    symbol = 'âœ“';
                    className = 'done';
                } else if (status === 'skipped') {
                    symbol = 'âœ—';
                    className = 'skipped';
                }
                tableHtml += `<td class="${className}">${symbol}</td>`;
            });
            tableHtml += '</tr>';
        }
        tableHtml += '</tbody></table>';

        printWindow.document.write(tableHtml);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
    }

    function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';

        input.onchange = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);

                    if (importedData.userName && importedData.workoutData) {
                        if (confirm(`Importera trÃ¤ningsdata fÃ¶r ${importedData.userName}? Detta kommer skriva Ã¶ver dina nuvarande data.`)) {
                            userName = importedData.userName;
                            workoutData = importedData.workoutData;
                            if (importedData.exercises && importedData.columnNames) {
                                exercises = importedData.exercises;
                                columnNames = importedData.columnNames;
                            }
                            saveData();

                            document.getElementById('nameInput').value = userName;
                            if (document.getElementById('trackerScreen').style.display !== 'none') {
                                updateHeader();
                                generateCalendar();
                                updateBadges();
                            }

                            const btn = document.querySelector('.import-btn');
                            const originalText = btn.textContent;
                            btn.textContent = 'âœ… Importerat!';
                            setTimeout(() => {
                                btn.textContent = originalText;
                            }, 2000);
                        }
                    } else {
                        alert('Ogiltigt filformat. VÃ¤lj en giltig JSON-fil frÃ¥n denna app.');
                    }
                } catch (error) {
                    alert('Kunde inte lÃ¤sa filen. Kontrollera att det Ã¤r en giltig JSON-fil.');
                }
            };
            reader.readAsText(file);
        };

        input.click();
    }


    // Initialize app
    window.addEventListener('load', () => {
        createManifest();
        loadData();

        document.getElementById('nameInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                startApp();
            }
        });
    });

    document.addEventListener('contextmenu', (e) => {
        if (e.target.classList.contains('exercise-cell')) {
            e.preventDefault();
        }
    });

    document.addEventListener('selectstart', (e) => {
        if (e.target.classList.contains('exercise-cell')) {
            e.preventDefault();
        }
    });


